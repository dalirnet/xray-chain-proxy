# قوانین مسیریابی

قوانین مسیریابی به شما امکان می‌دهند جریان ترافیک را در زنجیره پروکسی کنترل کنید. می‌توانید مشخص کنید کدام مقاصد باید مستقیم، از طریق پروکسی، یا به طور کامل مسدود شوند.

## خروجی‌های موجود

### سرور Gateway

| خروجی     | توضیحات                      | کاربرد                       |
|-----------|------------------------------|------------------------------|
| `direct`  | اتصال مستقیم به اینترنت      | ترافیک عادی                  |
| `blocked` | مسدود کردن کامل ترافیک       | تبلیغات، بدافزار، ردیابی     |

### سرور Edge

| خروجی     | توضیحات                      | کاربرد                       |
|-----------|------------------------------|------------------------------|
| `proxy`   | مسیریابی از طریق gateway     | محتوای فیلتر شده، حریم خصوصی |
| `direct`  | دور زدن پروکسی، اتصال مستقیم | استریم، سایت‌های محلی        |
| `blocked` | مسدود کردن در نقطه ورودی     | تبلیغات، بدافزار قبل gateway |

## انواع قوانین

### قوانین دامنه‌ای

تطبیق ترافیک بر اساس نام دامنه یا الگوهای دامنه.

**فرمت‌ها:**
- دامنه ساده: `google.com`، `facebook.com`
- پیشوند دامنه: `domain:netflix.com` (شامل زیردامنه‌ها)
- GeoSite: `geosite:cn`، `geosite:google`، `geosite:category-ads`

**مثال:**
```bash
./xcp.sh rule add
# Outbound: direct
# Type: 1 (domain)
# Domains: netflix.com,youtube.com,hulu.com
```

### قوانین IP

تطبیق ترافیک بر اساس آدرس IP یا محدوده CIDR.

**فرمت‌ها:**
- IP منفرد: `8.8.8.8`، `1.1.1.1`
- محدوده CIDR: `192.168.0.0/16`، `10.0.0.0/8`
- GeoIP: `geoip:us`، `geoip:cn`، `geoip:private`، `geoip:ir`

**مثال:**
```bash
./xcp.sh rule add
# Outbound: proxy
# Type: 2 (IP)
# IPs: geoip:cn,geoip:ru
```

## دستورات

### لیست قوانین

مشاهده همه قوانین مسیریابی سفارشی.

```bash
./xcp.sh rule ls
```

**خروجی:**
```
Routing Rules (edge):

1) → proxy
   Domain: twitter.com, facebook.com

2) → direct
   Domain: netflix.com, youtube.com

3) → blocked
   Domain: geosite:category-ads
```

### افزودن قانون

افزودن قانون مسیریابی جدید به صورت تعاملی.

```bash
./xcp.sh rule add
```

**درخواست‌ها:**
1. تگ خروجی (direct/proxy/blocked)
2. نوع قانون (1=دامنه، 2=IP)
3. مقادیر (جدا شده با کاما)

![Rule Add](https://raw.githubusercontent.com/dalirnet/xray-chain-proxy/main/showcase/gif/rule-add.gif)

### حذف قانون

حذف قانون مسیریابی با شماره.

```bash
./xcp.sh rule rm
```

قوانین فعلی را نمایش داده، شماره قانون مورد نظر را درخواست می‌کند.

## موارد استفاده رایج

### مسدود کردن تبلیغات (Gateway)

مسدود کردن دامنه‌های تبلیغاتی و ردیاب در نقطه خروجی gateway.

```bash
./xcp.sh rule add
# Outbound: blocked
# Type: domain
# Value: geosite:category-ads,geosite:category-ads-all
```

### دور زدن پروکسی برای استریم (Edge)

مسیریابی مستقیم سرویس‌های استریم برای سرعت بهتر.

```bash
./xcp.sh rule add
# Outbound: direct
# Type: domain
# Value: netflix.com,hulu.com,youtube.com,disney.com
```

### مسیریابی محتوای فیلتر شده (Edge)

اطمینان از عبور دامنه‌های خاص همیشه از طریق gateway.

```bash
./xcp.sh rule add
# Outbound: proxy
# Type: domain
# Value: twitter.com,facebook.com,instagram.com
```

### مسدود کردن دامنه‌های بدافزار (Edge)

مسدود کردن دامنه‌های مخرب شناخته شده در نقطه ورودی.

```bash
./xcp.sh rule add
# Outbound: blocked
# Type: domain
# Value: malware.example,phishing.bad,tracker.ads
```

### مسیریابی ترافیک کشور خاص

مسیریابی ترافیک از کشورهای خاص از طریق پروکسی.

```bash
./xcp.sh rule add
# Outbound: proxy
# Type: IP
# Value: geoip:cn,geoip:ir
```

### دسترسی مستقیم شبکه محلی (Edge)

دور زدن پروکسی برای ترافیک شبکه محلی.

```bash
./xcp.sh rule add
# Outbound: direct
# Type: IP
# Value: geoip:private,192.168.0.0/16,10.0.0.0/8
```

## اولویت قوانین

قوانین به ترتیب ارزیابی می‌شوند. اولین قانون منطبق برنده است.

### Gateway

1. **قانون داخلی API** - مسیریابی ترافیک API ایکس‌ری (127.0.0.1:10085)
2. **قانون مسدودسازی IP خصوصی** - مسدود کردن IPهای خصوصی (`geoip:private`)
3. **قوانین سفارشی** - قوانین اضافه شده توسط شما (از بالا به پایین)
4. **پیش‌فرض** - ترافیک باقی‌مانده به `direct` مسیریابی می‌شود (اولین خروجی)

### Edge

1. **قانون داخلی API** - مسیریابی ترافیک API ایکس‌ری (127.0.0.1:10085)
2. **قوانین سفارشی** - قوانین اضافه شده توسط شما (از بالا به پایین)
3. **قانون کلاینت داخلی** - مسیریابی تمام ترافیک کلاینت به `proxy`

**مهم:** قوانین سفارشی در Edge قبل از قانون کلاینت ارزیابی می‌شوند، که به شما اجازه می‌دهد رفتار پیش‌فرض پروکسی را برای دامنه‌ها/IPهای خاص تغییر دهید.

## داده‌های GeoIP و GeoSite

برای کارکرد قوانین GeoIP و GeoSite، فایل‌های داده جغرافیایی را در هنگام نصب Xray دانلود کنید:

```bash
# در هنگام راه‌اندازی، هنگام پرسش 'Y' را وارد کنید:
Download geo data (geoip.dat, geosite.dat)? [Y/n]: Y
```

**دسته‌بندی‌های رایج GeoSite:**
- `geosite:category-ads` - دامنه‌های تبلیغاتی
- `geosite:category-ads-all` - همه دامنه‌های مرتبط با تبلیغات
- `geosite:google` - سرویس‌های گوگل
- `geosite:netflix` - دامنه‌های نتفلیکس
- `geosite:cn` - دامنه‌های چینی

**کدهای رایج GeoIP:**
- `geoip:private` - محدوده‌های IP خصوصی
- `geoip:cn` - چین
- `geoip:us` - آمریکا
- `geoip:ir` - ایران
- `geoip:ru` - روسیه

## نکات

- **دقت در تست** - قوانین بلافاصله پس از افزودن اعمال می‌شوند
- **ترتیب مهم است** - قوانین خاص‌تر باید قبل از قوانین عمومی قرار گیرند
- **استفاده از جداسازی کاما** - برای کارایی بیشتر، چندین مقدار را در یک قانون اضافه کنید
- **بررسی لاگ‌ها** - از `./xcp.sh logs -f` برای مشاهده مسیریابی در عمل استفاده کنید
- **GeoSite برای تبلیغات** - از `geosite:category-ads-all` برای مسدودسازی جامع تبلیغات استفاده کنید
- **چندین IP** - GeoIP را با IPها/محدوده‌های خاص در یک قانون ترکیب کنید

## روند نمونه

### راه‌اندازی کامل Edge برای دور زدن فیلترینگ

```bash
# 1. مسدود کردن تبلیغات در ورودی
./xcp.sh rule add
# blocked, domain, geosite:category-ads-all

# 2. مسیریابی مستقیم استریم (سریع‌تر)
./xcp.sh rule add
# direct, domain, netflix.com,youtube.com,spotify.com

# 3. مسیریابی سایت‌های فیلتر شده از طریق پروکسی
./xcp.sh rule add
# proxy, domain, twitter.com,facebook.com,instagram.com

# 4. مشاهده پیکربندی
./xcp.sh rule ls

# 5. تست
./xcp.sh test
./xcp.sh logs -f
```

### مسدودسازی تبلیغات در Gateway

```bash
# مسدود کردن تبلیغات و ردیابی در خروجی
./xcp.sh rule add
# blocked, domain, geosite:category-ads-all

# مسدود کردن IPهای بدافزار شناخته شده
./xcp.sh rule add
# blocked, IP, 123.45.67.89,98.76.54.32
```

## سوالات متداول

**س: چگونه می‌توانم قوانین را ویرایش کنم؟**  
ج: قوانین را نمی‌توان ویرایش کرد. قانون قدیمی را حذف (`rule rm`) و قانون جدید را اضافه کنید (`rule add`).

**س: آیا می‌توانم اولویت قوانین را تغییر دهم؟**  
ج: در حال حاضر خیر. قوانین به ترتیب افزوده شدن اعمال می‌شوند. برای تغییر ترتیب، قوانین را حذف و به ترتیب مورد نظر دوباره اضافه کنید.

**س: تفاوت `domain:` و دامنه ساده چیست؟**  
ج: دامنه ساده (`google.com`) فقط دامنه دقیق را تطبیق می‌دهد. `domain:google.com` همه زیردامنه‌ها را نیز شامل می‌شود (مثل `mail.google.com`).

**س: چگونه ببینم قانونی کار می‌کند؟**  
ج: با `./xcp.sh logs -f` لاگ‌های زنده را مشاهده کنید. ترافیک منطبق با قوانین شما را خواهید دید.

**س: حداکثر تعداد قوانین چقدر است؟**  
ج: محدودیت سختی وجود ندارد، اما برای عملکرد بهتر، قوانین را ساده و کم نگه دارید.
